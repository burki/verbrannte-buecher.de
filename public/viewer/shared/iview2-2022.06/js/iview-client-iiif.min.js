var mycore,__extends=this&&this.__extends||function(){var a=function(e,t){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};return function(e,t){function i(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}}();!function(e){var t,i,a,r;t=e.viewer||(e.viewer={}),i=t.widgets||(t.widgets={}),a=i.iiif||(i.iiif={}),r=function(s){function e(e,t,i,a,r,o){var n=s.call(this,t,i,a,r,o,!1)||this;return n.smLinkMap=e,n}return __extends(e,s),e}(t.model.StructureModel),a.IIIFStructureModel=r}(mycore||(mycore={})),function(e){var c,t,i,a;c=e.viewer||(e.viewer={}),t=c.widgets||(c.widgets={}),i=t.iiif||(t.iiif={}),a=function(){function e(e,t,i){this.manifestDocument=e,this.tilePathBuilder=t,this.imageAPIURL=i,this.hrefResolverElement=document.createElement("a")}return e.prototype.processManifest=function(){return this.vIdFileMap=this.getIdFileMap(),new MyCoReMap,this.vChapterIdMap=new MyCoReMap,this.vIdPhysicalFileMap=void 0,this.vSmLinkMap=new MyCoReMap,this.vChapterImageMap=new MyCoReMap,this.vImageChapterMap=new MyCoReMap,this.vImprovisationMap=new MyCoReMap,this.vManifestChapter=this.processChapter(null,this.manifestDocument.getTopRanges()[0],this.manifestDocument.getSequences()[0].getCanvases()),this.vImageHrefImageMap=new MyCoReMap,this.vImageList=[],this.vIdImageMap=new MyCoReMap,this.processImages(),this.vStructureModel=new t.iiif.IIIFStructureModel(this.vSmLinkMap,this.vManifestChapter,this.vImageList,this.vChapterImageMap,this.vImageChapterMap,this.vImageHrefImageMap),this.vStructureModel},e.prototype.processChapter=function(e,t,i){var a,r=this;return void 0===t||0===t.getCanvasIds().length&&0===t.getRanges().length?(a=new c.model.StructureChapter(e,"","LOG_0",this.manifestDocument.getDefaultLabel()),this.vChapterIdMap.set(a.id,a),i.forEach(function(e){var t=new c.model.StructureChapter(a,a,r.getIDFromURL(e.id),e.getDefaultLabel());a.chapter.push(t),r.vChapterIdMap.set(t.id,t)})):(a=new c.model.StructureChapter(e,"",this.getIDFromURL(t.id),t.getDefaultLabel()),this.vChapterIdMap.set(a.id,a),t.getRanges().forEach(function(e){a.chapter.push(r.processChapter(a,e,[]))})),a},e.prototype.getIdFileMap=function(){var t=new MyCoReMap;return this.manifestDocument.getSequences()[0].getCanvases().forEach(function(e){e.getImages().forEach(function(e){void 0===e.id?t.set(e.getResource().id,e):t.set(e.id,e)})}),t},e.prototype.processImages=function(){var i=this,a=1;this.manifestDocument.getSequences()[0].getCanvases().forEach(function(e){var t=i.parseFile(e,a++);null!==t&&(i.vImageList.push(t),i.vIdImageMap.set(i.getIDFromURL(e.id),t))}),this.vImageList=this.vImageList.sort(function(e,t){return e.order-t.order}),0<this.manifestDocument.getTopRanges().length?this.makeLinks(this.manifestDocument.getTopRanges()[0]):this.makeLinksWithoutStructures(this.manifestDocument.getSequences()[0].getCanvases()),this.vImageList=this.vImageList.filter(function(e){return i.vImageChapterMap.has(e.id)}),this.vImageList.forEach(function(e,t){e.order=t+1,i.vImageHrefImageMap.set(e.href,e)})},e.prototype.makeLinks=function(e){var t=this,i=e;0===e.getCanvasIds().length&&0===e.getRanges().length&&this.makeLinksWithoutStructures(this.manifestDocument.getSequences()[0].getCanvases()),e.getCanvasIds().forEach(function(e){t.makeLink(t.vChapterIdMap.get(t.getIDFromURL(i.id)),t.vIdImageMap.get(t.getIDFromURL(e)))}),e.getRanges().forEach(function(e){t.makeLinks(e)})},e.prototype.makeLinksWithoutStructures=function(e){var t=this;e.forEach(function(e){t.makeLink(t.vChapterIdMap.get(t.getIDFromURL(e.id)),t.vIdImageMap.get(t.getIDFromURL(e.id)))})},e.prototype.makeLink=function(e,t){null===e.parent||this.vChapterImageMap.has(e.parent.id)||(this.vImprovisationMap.set(e.parent.id,!0),this.vChapterImageMap.set(e.parent.id,t)),(!this.vChapterImageMap.has(e.id)||this.vImageList.indexOf(this.vChapterImageMap.get(e.id))>this.vImageList.indexOf(t)||this.vImprovisationMap.has(e.id)&&this.vImprovisationMap.get(e.id))&&(this.vChapterImageMap.set(e.id,t),this.vImprovisationMap.set(e.id,!1)),this.vImageChapterMap.has(t.id)||this.vImageChapterMap.set(t.id,e),this.vSmLinkMap.has(e.id)||this.vSmLinkMap.set(e.id,[]),this.vSmLinkMap.get(e.id).push(t.href)},e.prototype.parseFile=function(e,t){var a=this,i=this.getHrefFromID(this.getIDFromURL(e.id)),r=parseInt(""+t,10),o=e.getDefaultLabel(),n=new MyCoReMap,s=null,h=null,l=null,u=null;return e.getImages().forEach(function(e){var t=e.getResource().getServices()[0].id,i=e.getResource().getFormat()?e.getResource().getFormat().toString():null;h=e.getResource().getWidth(),l=e.getResource().getHeight(),s=t.substr(t.indexOf(a.imageAPIURL)+a.imageAPIURL.length),u=i}),null===s?(console.warn("Unable to find MASTER|IVIEW2 file for "+i),null):new c.model.StructureImage("page",i,r,o,s,u,function(e){e(a.tilePathBuilder(s,h,l))},n,"",h,l)},e.prototype.getIDFromURL=function(e){return e.substr(e.lastIndexOf("/")+1)},e.prototype.getHrefFromID=function(e){return-1<e.indexOf("%2F")?e.substr(e.indexOf("%2F")+3):e},e}(),i.IIIFStructureBuilder=a}(mycore||(mycore={})),function(e){var t,i,n,a;t=e.viewer||(e.viewer={}),i=t.widgets||(t.widgets={}),n=i.iiif||(i.iiif={}),a=function(){function e(){}return e.loadModel=function(e,a,r){var o=new ViewerPromise,t={url:e,success:function(e){var t=manifesto.create(e),i=new n.IIIFStructureBuilder(t,r,a);o.resolve({model:i.processManifest(),document:e})},error:function(e,t,i){o.reject(i)}};return jQuery.ajax(t),o},e}(),n.IviewIIIFProvider=a}(mycore||(mycore={})),function(r){var e,o,n,t;e=r.viewer||(r.viewer={}),o=e.components||(e.components={}),n=r.viewer.components.events.ShowContentEvent,t=function(a){function e(e,t){var i=a.call(this)||this;return i.settings=e,i.container=t,i.errorSync=Utils.synchronize([function(e){return null!=e.lm&&e.error}],function(e){new r.viewer.widgets.modal.ViewerErrorModal(i.settings.mobile,e.lm.getTranslation("noStructFileShort"),e.lm.getFormatedTranslation("noStructFile",'<a href="mailto:"'+i.settings.adminMail+">"+i.settings.adminMail+"</a>"),i.settings.webApplicationBaseURL+"/modules/iview2/img/sad-emotion-egg.jpg",i.container[0]).show(),e.trigger(new n(i,jQuery(),r.viewer.widgets.layout.IviewBorderLayout.DIRECTION_WEST,0))}),i.error=!1,i.lm=null,i.mm=null,i}return __extends(e,a),e.prototype.postProcessChapter=function(e){var t=this;if((null===e.label||void 0===e.label||""===e.label)&&null!==e.type&&void 0!==e.type&&""!==e.type){var i=this.buildTranslationKey(e.type||"");this.lm.hasTranslation(i)&&(e._label=this.lm.getTranslation(i))}e.chapter.forEach(function(e){t.postProcessChapter(e)})},e.prototype.buildTranslationKey=function(e){return"dfgStructureSet."+e.replace("- ","")},e.prototype.structFileLoaded=function(e){this.postProcessChapter(e._rootChapter);var t=new o.events.StructureModelLoadedEvent(this,e);this.trigger(t),this.vStructFileLoaded=!0,this.vEventToTrigger=t;var i=this.settings.filePath,a=null;e._imageList.forEach(function(e){"/"+e.href!==i&&e.href!==i||(a=e)}),null!=a&&this.trigger(new o.events.ImageSelectedEvent(this,a))},Object.defineProperty(e.prototype,"handlesEvents",{get:function(){return[o.events.LanguageModelLoadedEvent.TYPE]},enumerable:!0,configurable:!0}),e}(o.ViewerComponent),o.MyCoReStructFileComponent=t}(mycore||(mycore={})),function(t){var e,i,a;e=t.viewer||(t.viewer={}),i=e.components||(e.components={}),a=function(a){function e(e,t){var i=a.call(this,e,t)||this;return i.settings=e,i.container=t,i.structFileAndLanguageSync=Utils.synchronize([function(e){return null!=e.mm},function(e){return null!=e.lm}],function(e){i.structFileLoaded(i.mm.model)}),i}return __extends(e,a),e.prototype.init=function(){var r=this;if("manifest"===this.settings.doctype){this.vStructFileLoaded=!1;var e=t.viewer.widgets.iiif.IviewIIIFProvider.loadModel(this.settings.manifestURL,this.settings.imageAPIURL,function(e,t,i){var a=r.getScaleFactor(t,i);return e+"/full/"+Math.floor(t/a)+","+Math.floor(i/a)+"/0/default.jpg"});e.then(function(e){var t=e.model;if(r.trigger(new i.events.WaitForEvent(r,i.events.LanguageModelLoadedEvent.TYPE)),null===t)return r.error=!0,void r.errorSync(r);r.mm=e,r.structFileAndLanguageSync(r)}),e.onreject(function(){r.trigger(new i.events.WaitForEvent(r,i.events.LanguageModelLoadedEvent.TYPE)),r.error=!0,r.errorSync(r)}),this.trigger(new i.events.ComponentInitializedEvent(this))}},e.prototype.handle=function(e){if(e.type===i.events.LanguageModelLoadedEvent.TYPE){var t=e;this.lm=t.languageModel,this.errorSync(this),this.structFileAndLanguageSync(this)}},e.prototype.getScaleFactor=function(e,t){var i=Math.min(256/e,256/t);return Math.pow(2,Math.ceil(Math.log(i)/Math.log(.5)))},e}(i.MyCoReStructFileComponent),i.MyCoReIIIFComponent=a}(mycore||(mycore={})),addViewerComponent(mycore.viewer.components.MyCoReIIIFComponent),function(e){var t,i;t=e.viewer||(e.viewer={}),function(e){var s=function(){function e(e,t,i,a,r){this.vPath=e,this.vTiles=t,this.vWidth=i,this.vHeight=a,this.vZoomlevel=r}return Object.defineProperty(e.prototype,"path",{get:function(){return this.vPath},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tiles",{get:function(){return this.vTiles},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this.vWidth},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.vHeight},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"zoomlevel",{get:function(){return this.vZoomlevel},enumerable:!0,configurable:!0}),e}();e.IIIFImageInformation=s;var t=function(){function o(){}return o.getInformation=function(i,a,r){void 0===r&&(r=function(e){});var e={url:i+"/info.json",async:!0,success:function(e){var t=o.proccessJSON(e,i);a(t)},error:function(e,t,i){r(i)}};jQuery.ajax(e)},o.proccessJSON=function(e,t){for(var i=e.tiles[0].scaleFactors,a=e.width,r=e.height,o=0,n=0;n<i.length+1;n++)o+=Math.ceil(a/(256*Math.pow(2,n)))*Math.ceil(r/(256*Math.pow(2,n)));return new s(t,o,a,r,i.length)},o}();e.IIIFImageInformationProvider=t}((i=t.widgets||(t.widgets={})).image||(i.image={}))}(mycore||(mycore={})),function(e){var t,i,a,r;t=e.viewer||(e.viewer={}),i=t.widgets||(t.widgets={}),a=i.canvas||(i.canvas={}),r=function(){function f(e,t,i,a){this.id=e,this.width=t,this.height=i,this.vTiles=new MyCoReMap,this.vLoadingTiles=new MyCoReMap,this.vBackBuffer=document.createElement("canvas"),this.vBackBufferArea=null,this.vBackBufferAreaZoom=null,this.vPreviewBackBuffer=document.createElement("canvas"),this.vPreviewBackBufferArea=null,this.vPreviewBackBufferAreaZoom=null,this.vImgPreviewLoaded=!1,this.vImgNotPreviewLoaded=!1,this.htmlContent=new ViewerProperty(this,"htmlContent"),this.vTilePath=a,this.loadTile(new Position3D(0,0,0))}return Object.defineProperty(f.prototype,"size",{get:function(){return new Size2D(this.width,this.height)},enumerable:!0,configurable:!0}),f.prototype.draw=function(e,t,i,a){(t.pos.x<0||t.pos.y<0)&&(t=new Rect(t.pos.max(0,0),t.size));var r=Math.min(this.getZoomLevel(i),this.maxZoomLevel()),o=this.scaleForLevel(r),n=i/o,s=f.TILE_SIZE/o,h=Math.floor(t.pos.x/s),l=Math.floor(t.pos.y/s),u=Math.ceil(Math.min(t.pos.x+t.size.width,this.size.width)/s),c=Math.ceil(Math.min(t.pos.y+t.size.height,this.size.height)/s);this.updateBackbuffer(h,l,u,c,r,a),e.save();var v=(h*s-t.pos.x)*i,g=(l*s-t.pos.y)*i;e.translate(v,g),e.scale(n,n),a?e.drawImage(this.vPreviewBackBuffer,0,0):e.drawImage(this.vBackBuffer,0,0),e.restore()},f.prototype.getHTMLContent=function(){return this.htmlContent},f.prototype.updateHTML=function(){void 0!==this.refreshCallback&&null!==this.refreshCallback&&this.refreshCallback()},f.prototype.clear=function(){this.abortLoadingTiles(),this.vBackBuffer.width=1,this.vBackBuffer.height=1;var e=this.vBackBufferAreaZoom=null,t=new Position3D(0,0,0),i=this.vTiles.has(t);i&&(e=this.vTiles.get(t)),this.vTiles.clear(),i&&this.vTiles.set(t,e),this.vLoadingTiles.clear()},f.prototype.updateBackbuffer=function(e,t,i,a,r,o){var n=new Rect(new Position2D(e,t),new Size2D(i-e,a-t));if(o){if(null!==this.vPreviewBackBufferArea&&!this.vImgPreviewLoaded&&this.vPreviewBackBufferArea.equals(n)&&r===this.vPreviewBackBufferAreaZoom)return;this.vPreviewBackBuffer.width=256*n.size.width,this.vPreviewBackBuffer.height=256*n.size.height,this.drawToBackbuffer(e,t,i,a,r,!0),this.vPreviewBackBufferArea=n,this.vPreviewBackBufferAreaZoom=r,this.vImgPreviewLoaded=!1}else{if(null!==this.vBackBufferArea&&!this.vImgNotPreviewLoaded&&this.vBackBufferArea.equals(n)&&r===this.vBackBufferAreaZoom)return;this.vBackBuffer.width=256*n.size.width,this.vBackBuffer.height=256*n.size.height,this.drawToBackbuffer(e,t,i,a,r,!1),this.vBackBufferArea=n,this.vBackBufferAreaZoom=r,this.vImgNotPreviewLoaded=!1}},f.prototype.abortLoadingTiles=function(){this.vLoadingTiles.forEach(function(e,t){delete t.src,delete t.onload,delete t.onerror}),this.vLoadingTiles.clear()},f.prototype.drawToBackbuffer=function(e,t,i,a,r,o){var n;n=o?this.vPreviewBackBuffer.getContext("2d"):this.vBackBuffer.getContext("2d");for(var s=e;s<i;s++)for(var h=t;h<a;h++){var l=new Position3D(s,h,r),u=this.loadTile(l),c=256*(s-e),v=256*(h-t);if(null!==u)n.drawImage(u,Math.floor(c),v,u.naturalWidth,u.naturalHeight);else{var g=this.getPreview(l);null!==g&&this.drawPreview(n,new Position2D(c,v),g)}}},f.prototype.drawPreview=function(e,t,i){i.areaToDraw.size.width=Math.min(i.areaToDraw.pos.x+i.areaToDraw.size.width,i.tile.naturalWidth)-i.areaToDraw.pos.x,i.areaToDraw.size.height=Math.min(i.areaToDraw.pos.y+i.areaToDraw.size.height,i.tile.naturalHeight)-i.areaToDraw.pos.y,e.drawImage(i.tile,i.areaToDraw.pos.x,i.areaToDraw.pos.y,i.areaToDraw.size.width,i.areaToDraw.size.height,t.x,t.y,i.areaToDraw.size.width*i.scale,i.areaToDraw.size.height*i.scale)},f.prototype.loadTile=function(t){var i=this;return this.vTiles.has(t)?this.vTiles.get(t):(this.vLoadingTiles.has(t)||this._loadTile(t,function(e){i.vTiles.set(t,e),void 0!==i.refreshCallback&&null!==i.refreshCallback&&(i.vImgPreviewLoaded=!0,i.vImgNotPreviewLoaded=!0,i.refreshCallback())},function(){console.error("Could not load tile : "+t.toString())}),null)},f.prototype.getPreview=function(e,t){if(void 0===t&&(t=1),this.vTiles.has(e))return{tile:this.vTiles.get(e),areaToDraw:new Rect(new Position2D(0,0),new Size2D(256,256)),scale:t};var i=e.z-1;if(i<0)return null;var a=new Position2D(Math.floor(e.x/2),Math.floor(e.y/2)),r=e.x%2,o=e.y%2,n=this.getPreview(new Position3D(a.x,a.y,i),2*t);if(null===n)return null;var s=new Size2D(n.areaToDraw.size.width/2,n.areaToDraw.size.height/2),h=new Position2D(n.areaToDraw.pos.x+s.width*r,n.areaToDraw.pos.y+s.height*o);return{tile:n.tile,areaToDraw:new Rect(h,s),scale:n.scale}},f.prototype.maxZoomLevel=function(){return Math.max(Math.ceil(Math.log(Math.max(this.width,this.height)/f.TILE_SIZE)/Math.LN2),0)},f.prototype.getZoomLevel=function(e){return Math.max(0,Math.ceil(this.maxZoomLevel()-Math.log(e)/Utils.LOG_HALF))},f.prototype.scaleForLevel=function(e){return Math.pow(.5,this.maxZoomLevel()-e)},f.prototype._loadTile=function(e,t,i){var a=this,r=Utils.hash(e.toString())%this.vTilePath.length,o=this.vTilePath[r],n=new Image;n.onload=function(){a.vLoadingTiles.remove(e),t(n)},n.onerror=function(){i()},n.src=ViewerFormatString(o,e),this.vLoadingTiles.set(e,n)},f.prototype.toString=function(){return this.vTilePath[0]},f.TILE_SIZE=256,f}(),a.TileImagePage=r}(mycore||(mycore={})),function(e){var t,i,a,r;t=e.viewer||(e.viewer={}),i=t.widgets||(t.widgets={}),a=i.canvas||(i.canvas={}),r=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.loadTile=function(t){var i=this,e=this.tilePosToIIIFPos(t);return this.vTiles.has(t)?this.vTiles.get(t):(this.vLoadingTiles.has(t)||this._loadTileIIIF(t,e,function(e){i.vTiles.set(t,e),void 0!==i.refreshCallback&&null!==i.refreshCallback&&(i.vImgPreviewLoaded=!0,i.vImgNotPreviewLoaded=!0,i.refreshCallback())},function(){console.error("Could not load tile : "+t.toString())}),null)},t.prototype.tilePosToIIIFPos=function(e){var t;return(t=e).x=256*t.x*Math.pow(2,this.maxZoomLevel()-t.z),t.w=256*Math.pow(2,this.maxZoomLevel()-t.z),t.y=256*t.y*Math.pow(2,this.maxZoomLevel()-t.z),t.h=256*Math.pow(2,this.maxZoomLevel()-t.z),t.tx=t.x+t.w>this.width?Math.ceil((this.width-t.x)/Math.pow(2,this.maxZoomLevel()-t.z)):256,t.ty=t.y+t.h>this.height?Math.ceil((this.height-t.y)/Math.pow(2,this.maxZoomLevel()-t.z)):256,t},t.prototype._loadTileIIIF=function(e,t,i,a){var r=this,o=Utils.hash(e.toString())%this.vTilePath.length,n=this.vTilePath[o],s=new Image;s.onload=function(){r.vLoadingTiles.remove(e),i(s)},s.onerror=function(){a()},s.src=ViewerFormatString(n,t),this.vLoadingTiles.set(e,s)},t}(a.TileImagePage),a.TileImagePageIIIF=r}(mycore||(mycore={})),function(r){var a,o,n,e;a=r.viewer||(r.viewer={}),o=a.components||(a.components={}),n=r.viewer.components.events.PageLoadedEvent,e=function(i){function e(e){var t=i.call(this)||this;return t.settings=e,t.vImageInformationMap=new MyCoReMap,t.vImagePageMap=new MyCoReMap,t.vImageHTMLMap=new MyCoReMap,t.vImageCallbackMap=new MyCoReMap,t}return __extends(e,i),e.prototype.init=function(){"manifest"===this.settings.doctype&&this.trigger(new o.events.WaitForEvent(this,o.events.RequestPageEvent.TYPE))},e.prototype.getPage=function(r,e){var o=this;if(this.vImagePageMap.has(r))e(this.vImagePageMap.get(r));else if(this.vImageCallbackMap.has(r))this.vImageCallbackMap.get(r).push(e);else{var t=[];t.push(e),this.vImageCallbackMap.set(r,t),this.getPageMetadata(r,function(e){for(var t,i=o.createPageFromMetadata(r,e),a=o.vImageCallbackMap.get(r);t=a.pop();)t(i);o.vImagePageMap.set(r,i),o.trigger(new n(o,r,i))})}},e.prototype.createPageFromMetadata=function(e,t){var i=[];return i.push(t.path+"/{x},{y},{w},{h}/!{tx},{ty}/0/default.jpg"),new a.widgets.canvas.TileImagePageIIIF(e,t.width,t.height,i)},e.prototype.getPageMetadata=function(t,i){var a=this;if(t="/"===t.charAt(0)?t.substr(1):t,this.vImageInformationMap.has(t))i(this.vImageInformationMap.get(t));else{var e=this.settings.imageAPIURL+t;r.viewer.widgets.image.IIIFImageInformationProvider.getInformation(e,function(e){a.vImageInformationMap.set(t,e),i(e)},function(e){console.log("Error while loading ImageInformations",+e.toString())})}},Object.defineProperty(e.prototype,"handlesEvents",{get:function(){return"manifest"===this.settings.doctype?[o.events.RequestPageEvent.TYPE]:[]},enumerable:!0,configurable:!0}),e.prototype.handle=function(e){if(e.type===o.events.RequestPageEvent.TYPE){var t=e;this.getPage(t._pageId,function(e){t._onResolve(t._pageId,e)})}},e}(o.ViewerComponent),o.MyCoReIIIFPageProviderComponent=e}(mycore||(mycore={})),addViewerComponent(mycore.viewer.components.MyCoReIIIFPageProviderComponent),console.log("IIIF MODULE");